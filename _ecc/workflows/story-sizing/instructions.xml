<workflow>
  <critical>The workflow execution engine is governed by: {project-root}/_bmad/core/tasks/workflow.xml</critical>
  <critical>You MUST have already loaded and processed: {installed_path}/workflow.yaml</critical>
  <critical>Communicate all responses in {communication_language} and generate all documents in {document_output_language}</critical>

  <critical>STORY SIZING - Validate and Split Oversized Stories</critical>
  <critical>This workflow analyzes existing stories for context window fit and splits oversized ones</critical>
  <critical>Model-aware sizing: Opus 4.6 handles larger context windows than previous models</critical>

  <!-- AGENT PERSONA LOADING -->
  <agent-loading>
    <critical>LOAD SM (SCRUM MASTER) AGENT PERSONA FOR STORY SIZING EXPERTISE</critical>
    <action>Load and embody: {project-root}/_bmad/bmm/agents/sm.md</action>
    <action>Apply SM agent's sizing expertise - focus on practical development capacity</action>
  </agent-loading>

  <!-- STEP 0: Project Knowledge Loading -->

  <step n="0" goal="Load project knowledge for sizing context">
    <action>Load project knowledge files:
      - {project-root}/_ecc/knowledge/code-review-patterns.md
      - {project-root}/.claude/rules/testing.md
    </action>
    <action>Load sizing lessons from project docs if available</action>
    <output>**Story Sizing Initialized**

      Project knowledge loaded for sizing context.
    </output>
  </step>

  <!-- STEP 1: Select Stories to Analyze -->

  <step n="1" goal="Select stories to analyze for sizing">
    <note>Stories can be analyzed individually or in batch from sprint status</note>

    <check if="{{story_path}} is provided by user">
      <action>Load single story from provided path</action>
      <action>Set {{analysis_mode}} = "single"</action>
      <action>GOTO step 2</action>
    </check>

    <action>Check if {{sprint_status}} file exists</action>
    <check if="sprint status file does NOT exist">
      <output>No sprint status file found and no story specified</output>
      <output>
        **Required Options:**
        1. Run `sprint-planning` to initialize sprint tracking
        2. Provide specific story path to analyze
        3. Provide story key to analyze
      </output>
      <ask>Choose option [1], [2], [3], or [X] to exit:</ask>

      <check if="user chooses X">
        <output>Workflow exited. No changes made.</output>
        <action>EXIT workflow gracefully</action>
      </check>

      <check if="user chooses 2 or 3">
        <ask>Please provide the story path or key:</ask>
        <action>Parse input and locate story file</action>
        <action>Set {{analysis_mode}} = "single"</action>
        <action>GOTO step 2</action>
      </check>
    </check>

    <!-- Load sprint status for batch analysis -->
    <critical>MUST read COMPLETE {sprint_status} file from start to end</critical>
    <action>Load the FULL file: {{sprint_status}}</action>
    <action>Find ALL stories with status = "ready-for-dev" OR "drafted"</action>
    <action>Set {{candidate_stories}} = list of story keys</action>
    <action>Set {{candidate_count}} = count of stories found</action>

    <check if="{{candidate_count}} == 0">
      <output>No stories found with status "ready-for-dev" or "drafted".

        All stories are either in backlog, in-progress, or done.
      </output>
      <ask>Would you like to analyze a specific story by path? [Y/N/X to exit]</ask>

      <check if="user chooses X or N">
        <output>Workflow exited. No changes made.</output>
        <action>EXIT workflow gracefully</action>
      </check>

      <check if="user chooses Y">
        <ask>Please provide the story path:</ask>
        <action>Parse input and locate story file</action>
        <action>Set {{analysis_mode}} = "single"</action>
        <action>GOTO step 2</action>
      </check>
    </check>

    <output>**Found {{candidate_count}} stories to analyze:**

      {{candidate_stories_list}}
    </output>

    <ask>
      Select analysis mode:
      1. **Analyze all** - Check all {{candidate_count}} stories for sizing issues
      2. **Select specific** - Choose which stories to analyze
      3. **Single story** - Analyze one specific story by key
      X. **Exit** workflow

      Choose [1], [2], [3], or [X]:
    </ask>

    <check if="user chooses X">
      <output>Workflow exited. No changes made.</output>
      <action>EXIT workflow gracefully</action>
    </check>

    <check if="user chooses 1">
      <action>Set {{analysis_mode}} = "batch"</action>
      <action>Set {{stories_to_analyze}} = {{candidate_stories}}</action>
    </check>

    <check if="user chooses 2">
      <ask>Enter story keys to analyze (comma-separated):</ask>
      <action>Parse user input into {{stories_to_analyze}}</action>
      <action>Set {{analysis_mode}} = "batch"</action>
    </check>

    <check if="user chooses 3">
      <ask>Enter story key to analyze:</ask>
      <action>Set {{stories_to_analyze}} = [user_input]</action>
      <action>Set {{analysis_mode}} = "single"</action>
    </check>
  </step>

  <!-- STEP 2: Load and Parse Story Content -->

  <step n="2" goal="Load and parse story content for analysis">
    <critical>EXHAUSTIVE STORY ANALYSIS</critical>

    <action>For each story in {{stories_to_analyze}}:</action>
    <action>  1. Locate story file using story key pattern</action>
    <action>  2. Load complete story file content</action>
    <action>  3. Parse sections: Tasks/Subtasks, Dev Notes, Acceptance Criteria</action>
    <action>  4. Extract metrics:</action>
    <action>     - task_count: Number of top-level tasks (lines starting with "- [ ] Task")</action>
    <action>     - subtask_count: Total subtasks across all tasks (nested "- [ ]" items)</action>
    <action>     - file_count: Estimated files from Dev Notes or task descriptions</action>
    <action>     - complexity_indicators: Test requirements, architectural changes, dependencies</action>
    <action>  5. Run `dust` on affected directories to assess current codebase size:</action>
    <action>     - `dust src/ -d 2` for source module sizes</action>
    <action>     - Use directory sizes to gauge context budget impact of proposed changes</action>

    <action>Set {{story_metrics}} = collected metrics for all stories</action>
  </step>

  <!-- STEP 3: Apply Sizing Analysis -->

  <step n="3" goal="Apply sizing heuristics and classify stories">
    <critical>CONTEXT WINDOW SIZING - Apply sizing heuristics (Opus 4.6 calibrated)</critical>

    <note>
      **Sizing Guidelines (Opus 4.6):**
      - **SMALL (1-2 pts):** 1-3 tasks, <=10 subtasks total, <=4 files
      - **MEDIUM (3-5 pts):** 3-6 tasks, <=25 subtasks total, <=8 files
      - **LARGE (5-8 pts):** 6-8 tasks, <=40 subtasks total, <=12 files
      - **TOO LARGE (needs split):** >8 tasks OR >40 subtasks OR >12 files

      **Key Insight:** Opus 4.6 can handle ~3x the context of previous models.
      Prefer fewer, larger stories to reduce context-switch overhead between stories.
    </note>

    <action>For each story in {{story_metrics}}:</action>
    <action>  Apply sizing classification based on metrics</action>
    <action>  Set {{story_size}} = SMALL | MEDIUM | LARGE | TOO_LARGE</action>

    <action>Categorize results:</action>
    <action>  {{ok_stories}} = stories classified as SMALL or MEDIUM</action>
    <action>  {{warning_stories}} = stories classified as LARGE</action>
    <action>  {{critical_stories}} = stories classified as TOO_LARGE</action>

    <output>
      **Sizing Analysis Complete**

      **Summary:**
      - OK (SMALL/MEDIUM): {{ok_count}} stories
      - WARNING (LARGE): {{warning_count}} stories
      - CRITICAL (TOO_LARGE): {{critical_count}} stories

      {{sizing_results_table}}
    </output>

    <check if="{{critical_count}} == 0 AND {{warning_count}} == 0">
      <output>**All stories are properly sized!**

        No stories require splitting. All are within context window capacity.
      </output>
      <action>GOTO step 6</action>
    </check>
  </step>

  <!-- STEP 4: Present Split Recommendations -->

  <step n="4" goal="Present split recommendations for oversized stories">
    <critical>SPLIT RECOMMENDATION ENGINE</critical>

    <check if="{{critical_count}} > 0">
      <output>
        **CRITICAL: {{critical_count}} stories REQUIRE splitting before development**

        These stories will exhaust the dev agent's context window mid-implementation:

        {{critical_stories_details}}
      </output>
    </check>

    <check if="{{warning_count}} > 0">
      <output>
        **WARNING: {{warning_count}} stories are at capacity**

        These stories are at the upper limit and may benefit from splitting:

        {{warning_stories_details}}
      </output>
    </check>

    <action>For each oversized story, generate split recommendations:</action>
    <action>  1. Analyze task groupings for natural split points</action>
    <action>  2. Suggest split strategy (by_layer, by_feature, by_phase, by_file)</action>
    <action>  3. Calculate metrics for proposed sub-stories</action>

    <output>
      **Recommended Splits:**

      {{split_recommendations}}
    </output>

    <ask>
      How would you like to proceed?
      1. **Auto-split all** - Apply recommended splits to all oversized stories
      2. **Review each** - Interactively review and approve each split
      3. **Skip warnings** - Only split CRITICAL stories, ignore warnings
      4. **Manual mode** - I'll specify my own split strategy
      X. **Exit** - Don't split anything

      Choose [1], [2], [3], [4], or [X]:
    </ask>

    <check if="user chooses X">
      <output>Workflow exited. No stories were split.</output>
      <action>GOTO step 6</action>
    </check>

    <check if="user chooses 1">
      <action>Set {{split_mode}} = "auto_all"</action>
      <action>Set {{stories_to_split}} = {{critical_stories}} + {{warning_stories}}</action>
    </check>

    <check if="user chooses 2">
      <action>Set {{split_mode}} = "interactive"</action>
      <action>GOTO step 4b</action>
    </check>

    <check if="user chooses 3">
      <action>Set {{split_mode}} = "auto_critical"</action>
      <action>Set {{stories_to_split}} = {{critical_stories}}</action>
    </check>

    <check if="user chooses 4">
      <action>Set {{split_mode}} = "manual"</action>
      <action>GOTO step 4c</action>
    </check>
  </step>

  <!-- STEP 4b: Interactive Split Review -->

  <step n="4b" goal="Interactive review of each split recommendation">
    <action>For each story in ({{critical_stories}} + {{warning_stories}}):</action>

    <output>
      **Story: {{current_story_key}}**

      **Current Metrics:**
      | Metric | Value | Guideline | Status |
      |--------|-------|-----------|--------|
      | Tasks | {{task_count}} | <=8 | {{task_status}} |
      | Subtasks | {{subtask_count}} | <=40 | {{subtask_status}} |
      | Files | {{file_count}} | <=12 | {{file_status}} |

      **Recommended Split Strategy: {{recommended_strategy}}**

      {{split_preview}}
    </output>

    <ask>
      Action for {{current_story_key}}:
      1. **Accept** - Apply this split
      2. **Modify** - Adjust the split strategy
      3. **Skip** - Don't split this story
      4. **Custom** - Define my own split
      X. **Exit** - Stop reviewing, proceed with accepted splits

      Choose [1], [2], [3], [4], or [X]:
    </ask>

    <check if="user chooses 1">
      <action>Add story to {{approved_splits}} with recommended strategy</action>
      <action>Continue to next story</action>
    </check>

    <check if="user chooses 2">
      <ask>Which split strategy? [by_layer/by_feature/by_phase/by_file]</ask>
      <action>Regenerate split preview with selected strategy</action>
      <action>Redisplay for approval</action>
    </check>

    <check if="user chooses 3">
      <action>Skip this story, continue to next</action>
    </check>

    <check if="user chooses 4">
      <ask>Describe your split approach (which tasks go in which sub-story):</ask>
      <action>Parse custom split definition</action>
      <action>Add to {{approved_splits}} with custom strategy</action>
    </check>

    <check if="user chooses X">
      <action>Set {{stories_to_split}} = {{approved_splits}}</action>
      <action>GOTO step 5</action>
    </check>

    <action>After all stories reviewed, set {{stories_to_split}} = {{approved_splits}}</action>
  </step>

  <!-- STEP 4c: Manual Split Mode -->

  <step n="4c" goal="Manual split specification">
    <output>
      **Manual Split Mode**

      Oversized stories to consider:
      {{oversized_stories_list}}
    </output>

    <ask>Which story would you like to split? (enter story key or [done] when finished)</ask>

    <check if="user says done">
      <action>GOTO step 5</action>
    </check>

    <action>Load selected story details</action>
    <output>
      **Story: {{selected_story_key}}**

      **Tasks:**
      {{task_list_numbered}}
    </output>

    <ask>How many sub-stories to create? [2-5]</ask>
    <action>For each sub-story, ask:</action>
    <ask>Sub-story {{n}} name and which tasks (by number):</ask>

    <action>Build custom split definition from user input</action>
    <action>Add to {{stories_to_split}}</action>
    <action>Ask if user wants to split another story</action>
  </step>

  <!-- STEP 5: Execute Splits and Create New Stories -->

  <step n="5" goal="Execute splits and create new story files">
    <critical>CREATING SPLIT STORY FILES</critical>

    <check if="{{stories_to_split}} is empty">
      <output>No stories selected for splitting.</output>
      <action>GOTO step 6</action>
    </check>

    <action>For each story in {{stories_to_split}}:</action>
    <action>  1. Generate sub-story keys using letter suffix (e.g., 1-2 -> 1-2a, 1-2b)</action>
    <action>  2. Create new story files from template</action>
    <action>  3. Distribute tasks according to split strategy</action>
    <action>  4. Copy relevant Dev Notes and Acceptance Criteria</action>
    <action>  5. Add dependency note: "Part of split from {{original_story_key}}"</action>
    <action>  6. Add cross-references between split stories</action>
    <action>  7. Mark original story as "split" or archive it</action>

    <output>
      **Split Complete: {{original_story_key}}**

      **Created {{sub_story_count}} sub-stories:**
      {{created_stories_list}}

      **Original story archived/marked as split**
    </output>

    <action>After all splits complete:</action>
    <action>Set {{total_created}} = count of new stories</action>
    <action>Set {{total_archived}} = count of original stories archived</action>
  </step>

  <!-- STEP 6: Update Sprint Status -->

  <step n="6" goal="Update sprint status with split results">
    <check if="sprint status file exists AND splits were made">
      <critical>MUST update {sprint_status} with new stories</critical>
      <action>Load the FULL file: {{sprint_status}}</action>

      <action>For each split story:</action>
      <action>  1. Update original story status to "split" or remove entry</action>
      <action>  2. Add entries for each new sub-story with status "ready-for-dev"</action>
      <action>  3. Preserve story ordering within epic</action>

      <action>Save file, preserving ALL comments and structure</action>

      <output>
        **Sprint Status Updated**

        - Archived/marked as split: {{total_archived}} stories
        - Added new entries: {{total_created}} stories
      </output>
    </check>

    <check if="no splits were made">
      <output>No changes to sprint status required.</output>
    </check>
  </step>

  <!-- STEP 7: Summary and Next Steps -->

  <step n="7" goal="Present sizing results and next steps">
    <output>**STORY SIZING COMPLETE, {user_name}!**

      **Analysis Summary:**
      - Stories Analyzed: {{total_analyzed}}
      - OK (no action needed): {{ok_count}}
      - Split: {{total_archived}} -> {{total_created}} new stories

      **Files Modified:**
      {{modified_files_list}}

      **Next Steps:**
      1. Review the split stories in their respective files
      2. Mark split stories ready for dev
      3. Prioritize sub-stories in sprint planning

      **Sizing Tip:** Consider using `ecc-create-story` for future stories -
      it includes built-in sizing checks via mid-story sizing.
    </output>
  </step>

</workflow>
