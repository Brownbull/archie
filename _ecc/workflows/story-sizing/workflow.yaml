# Story Sizing - Validate and Split Oversized Stories
name: story-sizing
description: "Analyze existing stories for context window fit, detect oversized stories, and split them into smaller implementation units. Prevents dev agent context exhaustion."
author: "BMad"

# Critical variables from config
config_source: "{project-root}/_bmad/bmm/config.yaml"
output_folder: "{config_source}:output_folder"
user_name: "{config_source}:user_name"
communication_language: "{config_source}:communication_language"
document_output_language: "{config_source}:document_output_language"
date: system-generated
implementation_artifacts: "{config_source}:implementation_artifacts"
story_dir: "{implementation_artifacts}"

# Workflow components
installed_path: "{project-root}/_ecc/workflows/story-sizing"
template: "{project-root}/_bmad/bmm/workflows/4-implementation/create-story/template.md"
instructions: "{installed_path}/instructions.xml"

# Project Knowledge Integration
project_knowledge:
  enabled: true
  files:
    - "{project-root}/_ecc/knowledge/code-review-patterns.md"
    - "{project-root}/.claude/rules/testing.md"

# Variables and inputs
variables:
  sprint_status: "{implementation_artifacts}/sprint-status.yaml"
  epics_file: "{output_folder}/planning-artifacts/epics.md"
  story_path: ""  # User can provide specific story or auto-discover

# Project context
project_context: "**/project-context.md"

# Smart input file references
input_file_patterns:
  sprint_status:
    description: "Sprint status for story discovery"
    whole: "{implementation_artifacts}/sprint-status.yaml"
    load_strategy: "FULL_LOAD"
  project_knowledge:
    description: "Project patterns for sizing context"
    whole: "{project-root}/_ecc/knowledge/code-review-patterns.md"
    load_strategy: "SELECTIVE_LOAD"
  stories:
    description: "Existing story files to analyze"
    whole: "{implementation_artifacts}/**/*.md"
    load_strategy: "ON_DEMAND"

standalone: true

# Sizing Features
sizing_features:
  story_size_analysis: true
  split_recommendation: true

# Story Sizing Heuristics (Opus 4.6)
sizing_guidelines:
  small:
    points: "1-2"
    max_tasks: 3
    max_subtasks: 10
    max_files: 4
    description: "Single-focus story, completes in one session"
  medium:
    points: "3-5"
    max_tasks: 6
    max_subtasks: 25
    max_files: 8
    description: "Standard story, comfortable for one context window"
  large:
    points: "5-8"
    max_tasks: 8
    max_subtasks: 40
    max_files: 12
    description: "At capacity - consider splitting if complex"
  too_large:
    description: "REQUIRES SPLIT before development"
    threshold: ">8 tasks OR >40 subtasks OR >12 files"
    action: "Mandatory split into smaller stories"

# Split strategy patterns
split_strategies:
  by_layer:
    description: "Split by architectural layer (UI, Services, Types)"
    example: "Story A: Types + services, Story B: Components + UI"
  by_feature:
    description: "Split by feature subset"
    example: "Story A: Core feature, Story B: Edge cases and error handling"
  by_phase:
    description: "Split by implementation phase"
    example: "Story A: Scaffolding and interfaces, Story B: Implementation"
  by_file:
    description: "Split by file groups"
    example: "Story A: Files 1-6, Story B: Files 7-12"
